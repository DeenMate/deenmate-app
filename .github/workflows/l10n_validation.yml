name: Localization Validation

on:
  push:
    branches: [ main, develop, 'feature/QURAN-*' ]
    paths:
      - 'lib/l10n/**'
      - 'lib/features/quran/**'
      - 'scripts/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lib/l10n/**'
      - 'lib/features/quran/**'
      - 'scripts/**'

jobs:
  validate-localization:
    name: Validate Translations and Check Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“± Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ğŸ”§ Generate localizations
        run: flutter gen-l10n
        
      - name: ğŸ” Check for hardcoded strings
        run: |
          echo "ğŸ” Scanning for hardcoded strings in Quran module..."
          dart run scripts/find_hardcoded_strings.dart lib/features/quran/
          
      - name: âœ… Validate translations
        run: |
          echo "âœ… Validating ARB translations..."
          dart run scripts/validate_translations.dart
          
      - name: ğŸ“Š Generate coverage report
        run: |
          echo "ğŸ“Š Generating localization coverage report..."
          dart run scripts/l10n_coverage_report.dart
          
      - name: ğŸ“‹ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: l10n-coverage-report
          path: coverage/l10n_coverage_report.json
          
      - name: ğŸ’¬ Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            try {
              const reportPath = 'coverage/l10n_coverage_report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                let comment = `## ğŸŒ Localization Coverage Report\n\n`;
                comment += `**Overall Coverage**: ${report.averageCoverage.toFixed(1)}%\n`;
                comment += `**Total Keys**: ${report.totalKeys}\n\n`;
                
                comment += `### Per-Locale Coverage\n`;
                for (const locale of report.locales) {
                  const coverage = report.localeCoverage[locale];
                  const status = coverage >= 95 ? 'âœ…' : coverage >= 80 ? 'âš ï¸' : 'âŒ';
                  comment += `${status} **${locale}**: ${coverage.toFixed(1)}%\n`;
                }
                
                if (Object.values(report.missingKeys).some(keys => keys.length > 0)) {
                  comment += `\n### âš ï¸ Missing Translations\n`;
                  for (const [locale, keys] of Object.entries(report.missingKeys)) {
                    if (keys.length > 0) {
                      comment += `- **${locale}**: ${keys.slice(0, 3).join(', ')}${keys.length > 3 ? '...' : ''}\n`;
                    }
                  }
                }
                
                comment += `\n### ğŸ¯ Feature Coverage\n`;
                for (const [feature, coverage] of Object.entries(report.featureCoverage)) {
                  const status = coverage >= 95 ? 'âœ…' : coverage >= 80 ? 'âš ï¸' : 'âŒ';
                  comment += `${status} **${feature}**: ${coverage.toFixed(1)}%\n`;
                }
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not generate coverage comment:', error);
            }

  test-localization:
    name: Test Localized Components
    runs-on: ubuntu-latest
    needs: validate-localization
    
    strategy:
      matrix:
        locale: ['en', 'bn']
        
    steps:
      - name: ğŸ“± Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ğŸ”§ Generate localizations
        run: flutter gen-l10n
        
      - name: ğŸ§ª Run localization tests
        run: |
          echo "ğŸ§ª Running tests for locale: ${{ matrix.locale }}"
          flutter test --coverage test/l10n/ --test-randomize-ordering-seed=random
          
      - name: ğŸ§ª Run widget tests with locale
        run: |
          echo "ğŸ§ª Running widget tests with locale: ${{ matrix.locale }}"
          flutter test test/features/quran/ --coverage --test-randomize-ordering-seed=random
          
      - name: ğŸ“Š Upload test coverage
        if: matrix.locale == 'en'
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          name: localization-tests
          
  validate-islamic-terminology:
    name: Validate Islamic Terminology
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“± Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ğŸ•Œ Validate Islamic terms
        run: |
          echo "ğŸ•Œ Validating Islamic terminology consistency..."
          
          # Check for consistent Islamic terminology
          echo "Checking Prayer Time terms..."
          grep -r "fajr\|dhuhr\|asr\|maghrib\|isha" lib/l10n/ || echo "No prayer time terms found"
          
          echo "Checking Quran terms..."
          grep -r "surah\|ayah\|juz\|hizb\|ruku" lib/l10n/ || echo "No Quran terms found"
          
          echo "Checking Audio terms..."
          grep -r "reciter\|qari\|tilawah" lib/l10n/ || echo "No audio terms found"
          
          # Validate that Bengali translations exist for key Islamic terms
          if [ -f "lib/l10n/app_bn.arb" ]; then
            echo "âœ… Bengali ARB file exists"
            
            # Check for key Islamic terms in Bengali
            if grep -q "à¦¨à¦¾à¦®à¦¾à¦œ\|à¦«à¦œà¦°\|à¦¯à§à¦¹à¦°\|à¦†à¦¸à¦°\|à¦®à¦¾à¦—à¦°à¦¿à¦¬\|à¦‡à¦¶à¦¾" lib/l10n/app_bn.arb; then
              echo "âœ… Bengali prayer terms found"
            else
              echo "âš ï¸ Consider adding Bengali prayer terms"
            fi
            
            if grep -q "à¦•à§à¦°à¦†à¦¨\|à¦¸à§‚à¦°à¦¾\|à¦†à¦¯à¦¼à¦¾à¦¤" lib/l10n/app_bn.arb; then
              echo "âœ… Bengali Quran terms found"
            else
              echo "âš ï¸ Consider adding Bengali Quran terms"
            fi
          fi

  performance-check:
    name: Check Localization Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“± Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ğŸ”§ Generate localizations
        run: flutter gen-l10n
        
      - name: âš¡ Check localization file sizes
        run: |
          echo "âš¡ Checking localization file sizes..."
          
          for file in lib/l10n/*.arb; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              echo "ğŸ“„ $(basename "$file"): ${size} bytes"
              
              # Warn if ARB file is getting very large (>100KB)
              if [ "$size" -gt 102400 ]; then
                echo "âš ï¸ Warning: $file is over 100KB. Consider splitting into modules."
              fi
            fi
          done
          
      - name: ğŸ” Check for duplicate keys
        run: |
          echo "ğŸ” Checking for duplicate keys in ARB files..."
          
          for file in lib/l10n/*.arb; do
            if [ -f "$file" ]; then
              echo "Checking $(basename "$file")..."
              
              # Extract all keys and check for duplicates
              if command -v jq >/dev/null 2>&1; then
                duplicates=$(jq -r 'keys[]' "$file" | sort | uniq -d)
                if [ -n "$duplicates" ]; then
                  echo "âŒ Duplicate keys found in $file: $duplicates"
                  exit 1
                else
                  echo "âœ… No duplicate keys in $(basename "$file")"
                fi
              else
                echo "âš ï¸ jq not available, skipping duplicate check"
              fi
            fi
          done
